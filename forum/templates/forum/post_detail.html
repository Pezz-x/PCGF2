{% extends "base.html" %}
{% block content %}

<div class="post-detail">
    <h2>{{ post.title }}</h2>
    <p class="post-meta">
        Posted by {{ post.author }} on {{ post.time_created|date:"F j, Y, g:i a" }}
    </p>

    {% if post.image %}
    <div class="post-image">
        <img src="{{ post.image.url }}" alt="Post image" width="500" />
    </div>
    {% endif %}

    <div class="post-body">{{ post.body|linebreaks }}</div>

    <!-- Edit/Delete buttons for post -->
    {% if user == post.author %}
    <div class="post-actions">
        <a href="{% url 'post_edit' post.slug %}" class="btn">Edit</a>
        <form id="delete-post-form" method="post" action="{% url 'post_delete' post.slug %}" style="display: none">
            {% csrf_token %}
        </form>
    </div>
    {% endif %}

    <hr />

    <!-- Likes -->
    <div class="likes-section">
        <form method="post" action="{% url 'post_like_toggle' post.slug %}">
            {% csrf_token %}
            {% if post.liked_by_user %}
                <button type="submit" class="btn btn-unlike">Unlike</button>
            {% else %}
                <button type="submit" class="btn btn-like">Like</button>
            {% endif %}
        </form>
        <span>{{ post.like_count }} like{{ post.like_count|pluralize }}</span>
    </div>

    <hr />

    <!-- Comments -->
    <h3>Comments ({{ comments.count }})</h3>
    {% for comment in comments %}
    <div class="comment">
        <p>
            <strong>{{ comment.author }}</strong> on {{ comment.created_on|date:"F j, Y, g:i a" }}
        </p>
        <p>{{ comment.body|linebreaks }}</p>

        <div class="comment-actions">
            <!-- Comment likes -->
            <form method="post" action="{% url 'toggle_comment_like' comment.id %}">
                {% csrf_token %}
                {% if comment.liked_by_user %}
                    <button type="submit" class="btn btn-unlike">Unlike</button>
                {% else %}
                    <button type="submit" class="btn btn-like">Like</button>
                {% endif %}
            </form>
            <span>{{ comment.like_count }} like{{ comment.like_count|pluralize }}</span>

            <!-- Edit/Delete buttons for comment -->
            {% if user == comment.author %}
                <a href="{% url 'comment_edit' post.slug comment.id %}" class="btn">Edit</a>
                <form method="post" action="{% url 'comment_delete' post.slug comment.id %}" style="display: inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <p>No comments yet.</p>
    {% endfor %}

    <hr />

    <!-- Add Comment Form -->
    {% if user.is_authenticated %}
    <form method="post" action="{% url 'post_detail' post.slug %}">
        {% csrf_token %}
        {{ comment_form.as_p }}
        <button type="submit" class="btn btn-submit">Submit</button>
    </form>
    {% else %}
        <p><a href="{% url 'login' %}">Log in</a> to add a comment.</p>
    {% endif %}
</div>

<!-- Modal for delete confirmation -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6);">
    <div style="background: #fff; padding: 20px; max-width: 400px; margin: 100px auto; border-radius: 8px; text-align: center;">
        <h3>Are you sure you want to delete this post?</h3>
        <button onclick="confirmDelete()" class="btn btn-danger">Yes, delete</button>
        <button onclick="closeDeleteModal()" class="btn">Cancel</button>
    </div>
</div>

<script>
    function openDeleteModal() {
        document.getElementById("deleteModal").style.display = "block";
    }
    function closeDeleteModal() {
        document.getElementById("deleteModal").style.display = "none";
    }
    function confirmDelete() {
        document.getElementById("delete-post-form").submit();
    }
</script>

{% endblock %}
